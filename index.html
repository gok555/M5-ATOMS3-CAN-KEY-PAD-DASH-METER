<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M5Atom CAN Keypad (v3.83 Final Fix)</title>
    <style>
        /* Reset & Base */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; height: 100dvh;
            overflow: hidden; background-color: #1a1a1a; color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: manipulation; display: flex; flex-direction: column;
        }
        /* --- Views --- */
        .view-container {
            display: none; flex: 1; flex-direction: column; box-sizing: border-box;
            padding: 10px; width: 100%; height: 100%; overflow: hidden;
        }
        .view-container.active { display: flex; }
        /* --- Main View --- */
        #view-main { position: relative; }
        .main-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px; padding: 0 5px; flex-shrink: 0; height: 40px;
        }
        .status-group { display: flex; align-items: center; gap: 10px; }
        .status-indicator { font-size: 0.9rem; color: #888; font-weight: bold; }
        .status-indicator.connected { color: #28a745; }
        .header-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer;
            padding: 5px; color: #aaa; line-height: 1;
        }
        /* Connect Overlay */
        #connect-overlay {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            width: 100%; height: 100%; position: absolute; top: 40px; left: 0; bottom: 0;
            background: #1a1a1a; z-index: 10;
        }
        #start-btn {
            width: 200px; height: 200px; border-radius: 50%; border: 4px solid #007bff;
            background: rgba(0, 123, 255, 0.1); color: #007bff; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 0 20px rgba(0, 123, 255, 0.3); transition: all 0.2s ease;
            display: flex; justify-content: center; align-items: center; text-align: center;
        }
        #keypad {
            display: none; gap: 8px; flex-grow: 1; width: 100%; max-width: 600px; align-self: center;
            grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr);
        }
        #keypad.visible { display: grid; }
        @media (orientation: landscape) {
            #keypad { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); }
            .main-header { margin-bottom: 2px; height: 30px; }
            #connect-overlay { top: 30px; }
        }
        .key-btn {
            background: #333; border: 3px solid var(--btn-color, #777); border-radius: 12px;
            color: var(--btn-color, #fff); font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); position: relative; text-align: center;
            width: 100%; height: 100%; user-select: none; font-size: clamp(1rem, 5vw, 2rem);
            transition: all 0.1s ease;
        }
        .key-btn.active { background: var(--btn-color, #006000); color: #fff; box-shadow: 0 0 15px var(--btn-color, rgba(0, 255, 0, 0.4)); }
        .key-btn.pressing { transform: scale(0.95); opacity: 0.8; }
        
        /* --- Settings View --- */
        #view-settings { background: #222; overflow-y: auto; align-items: center; }
        .settings-header {
            display: flex; width: 100%; align-items: center; margin-bottom: 20px;
            padding-bottom: 10px; border-bottom: 1px solid #444; flex-shrink: 0;
        }
        .settings-group { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 15px; padding: 0 5px; box-sizing: border-box; }
        .control-row { width: 100%; }
        .action-btn { width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px; border: none; color: white; cursor: pointer; font-weight: bold; }
        .btn-orange { background: #e67e22; } .btn-red { background: #dc3545; } .btn-blue { background: #007bff; } .btn-gray { background: #555; }
        
        .id-input-group { display: flex; align-items: center; background: #333; padding: 5px; border-radius: 8px; gap: 5px; width: 100%; box-sizing: border-box; }
        input, select { background: #222; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; text-align: center; font-family: monospace; font-size: 1rem; }

        /* Button Configuration List (v3.7 Layout Restored) */
        .config-list { display: flex; flex-direction: column; gap: 10px; background: #2a2a2a; padding: 10px; border-radius: 8px; }
        .config-row { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: #333; padding: 10px; border-radius: 6px; gap: 8px; }
        .config-name-input { flex: 1; min-width: 80px; font-size: 1rem; }
        .mini-switch { display: flex; background: #222; border-radius: 4px; padding: 2px; gap: 2px; }
        .mini-opt { border: none; background: none; color: #666; font-size: 0.8rem; padding: 6px 8px; border-radius: 3px; cursor: pointer; }
        .mini-opt.selected { background: #555; color: #fff; font-weight: bold; }

        /* Animations */
        @keyframes pulse-mic { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes blink-red { 0% { color: #ff0000; text-shadow: 0 0 10px #ff0000; } 50% { color: #880000; text-shadow: none; } 100% { color: #ff0000; text-shadow: 0 0 10px #ff0000; } }
        .temp-warning { animation: blink-red 1s infinite; font-weight: bold; font-size: 1.4rem !important; }

        /* Meter View */
        #view-meter { background: #000; flex-direction: column; padding-top: 50px; }
        #meter-grid { display: grid; gap: 8px; width: 100%; height: 100%; padding: 10px; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr); }
        .meter-cell { background: #111; border: 2px solid #333; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .meter-label { position: absolute; top: 5px; width: 100%; text-align: center; color: #888; font-size: 0.8rem; font-weight: bold; }
        .meter-value { font-family: monospace; font-weight: bold; font-size: clamp(1.5rem, 6vw, 2.5rem); color: #fff; }
        .meter-unit { position: absolute; bottom: 5px; right: 10px; color: #666; font-size: 0.7rem; }
    </style>
</head>
<body>
    <div id="view-meter" class="view-container">
        <button class="meter-header-btn" style="position:absolute; top:10px; left:10px; padding:10px; background:#333; color:white; border:none; border-radius:5px;" onclick="showMain()">‚Ü©Ô∏è Back</button>
        <div id="meter-grid">
            <div class="meter-cell"><div class="meter-label">Exhaust Temp</div><div id="meter-val-1" class="meter-value" style="color:#00FFFF;">--</div><div class="meter-unit">¬∞C</div></div>
            <div class="meter-cell"><div id="meter-label-2" class="meter-label">RX Monitor</div><div id="meter-val-2" class="meter-value" style="color:#FFD700;">---</div><div class="meter-unit" id="meter-unit-2">RAW</div></div>
            <div class="meter-cell"><div id="meter-label-3" class="meter-label">RX Mon 2</div><div id="meter-val-3" class="meter-value" style="color:#444;">---</div><div class="meter-unit" id="meter-unit-3"></div></div>
            <div class="meter-cell"><div id="meter-label-4" class="meter-label">RX Mon 3</div><div id="meter-val-4" class="meter-value" style="color:#444;">---</div><div class="meter-unit" id="meter-unit-4"></div></div>
            <div class="meter-cell"><div id="meter-label-5" class="meter-label">RX Mon 4</div><div id="meter-val-5" class="meter-value" style="color:#444;">---</div><div class="meter-unit" id="meter-unit-5"></div></div>
            <div class="meter-cell"><div id="meter-label-6" class="meter-label">RX Mon 5</div><div id="meter-val-6" class="meter-value" style="color:#444;">---</div><div class="meter-unit" id="meter-unit-6"></div></div>
            <div class="meter-cell"><div id="meter-label-7" class="meter-label">RX Mon 6</div><div id="meter-val-7" class="meter-value" style="color:#444;">---</div><div class="meter-unit" id="meter-unit-7"></div></div>
            <div class="meter-cell"><div id="meter-label-8" class="meter-label">RX Mon 7</div><div id="meter-val-8" class="meter-value" style="color:#444;">---</div><div class="meter-unit" id="meter-unit-8"></div></div>
        </div>
    </div>

    <div id="view-main" class="view-container active">
        <div class="main-header">
            <div class="status-group">
                <div id="status-display" class="status-indicator">üî¥ Disconnected</div>
                <div id="can-status-display" class="status-indicator" style="display:none; font-size:0.8rem; border-left:1px solid #444; padding-left:10px;">CAN: --</div>
            </div>
            <div style="flex:1;"></div>
            <div style="display:flex; gap:15px; align-items:center;">
                <button id="meter-view-btn" class="header-btn" onclick="showMeter()">üìü</button>
                <button id="main-sound-btn" class="header-btn" onclick="toggleSoundMain()">üîä</button>
                <button class="header-btn" onclick="toggleFullscreen()">‚õ∂</button>
                <button id="settings-btn" class="header-btn" onclick="showSettings()">‚öôÔ∏è</button>
            </div>
        </div>
        <div id="connect-overlay"><button id="start-btn" onclick="handleStartConnect()">CONNECT<br>START</button></div>
        <div id="sync-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:20; color:white; display:flex; align-items:center; justify-content:center;">‚öôÔ∏è Syncing...</div>
        <div id="keypad"></div>
    </div>

    <div id="view-settings" class="view-container">
        <div class="settings-header">
            <button class="back-btn" style="background:none; border:none; color:white; font-size:1.2rem;" onclick="showMain()">‚Äπ Back</button>
            <div style="flex-grow:1; text-align:center; font-weight:bold;">Settings (v3.83 Fix)</div>
            <div style="width:50px;"></div>
        </div>
        
        <div class="settings-group">
            <div id="disconnect-row" style="display:none;"><button class="action-btn btn-red" onclick="disconnect()">üî¥ Disconnect</button></div>
            
            <div class="id-input-group"><label style="min-width:60px;">PAD:0x</label><input type="text" id="can-id-input" maxlength="3" style="flex:1;"><button class="action-btn btn-orange" style="width:auto; padding:8px 20px;" onclick="setCanId()">SET</button></div>
            <div class="id-input-group"><label style="min-width:60px;">KID:0x</label><input type="text" id="k-meter-id-input" maxlength="3" style="flex:1;"><button class="action-btn btn-orange" style="width:auto; padding:8px 20px;" onclick="setKMeterId()">SET</button></div>
            
            <div style="display:flex; gap:5px;">
                <div class="id-input-group" style="flex:0.4;"><input type="color" id="temp-color-input" style="width:100%; border:none; background:none;"></div>
                <div class="id-input-group" style="flex:1; border:1px solid #d35400;"><label style="color:#e67e22;">Alm:¬∞C</label><input type="number" id="temp-alarm-input" style="flex:1;"></div>
            </div>

            <div style="border-bottom:1px solid #444; padding-bottom:10px;">
                <div style="color:#ccc; font-size:0.9rem; margin-bottom:5px;">Biometric Registration (Security)</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div id="bio-status" style="font-size:0.8rem; color:#888;">Checking...</div>
                    <div style="display:flex; gap:10px;">
                        <button id="btn-bio-reg" class="action-btn btn-blue" style="width:auto; padding:8px 15px;" onclick="registerBiometric()">Register</button>
                        <button id="btn-bio-clear" class="action-btn btn-red" style="width:auto; padding:8px 15px; display:none;" onclick="clearBiometric()">Clear</button>
                    </div>
                </div>
            </div>

            <div style="color:#ccc; font-size:0.9rem; margin-left:5px;">Button Configuration</div>
            <div id="config-list-container" class="config-list"></div>

            <div style="border-top:1px solid #444; padding-top:10px;">
                <div style="color:#ccc; font-size:0.9rem; margin-bottom:5px;">üì° RX Monitor Config (7 Slots)</div>
                <select id="rx-slot-select" onchange="loadRxSlotFromUI()" style="width:100%; background:#005cbf; font-weight:bold; padding:10px; margin-bottom:10px;">
                     <option value="0">Monitor 1 (VAL)</option><option value="1">Monitor 2 (VAL2)</option><option value="2">Monitor 3 (VAL3)</option>
                     <option value="3">Monitor 4 (VAL4)</option><option value="4">Monitor 5 (VAL5)</option><option value="5">Monitor 6 (VAL6)</option><option value="6">Monitor 7 (VAL7)</option>
                </select>
                <div class="id-input-group"><input type="color" id="rx-color-input" style="width:40px; height:35px; border:none; background:none;"><label style="min-width:40px;">Name</label><input type="text" id="rx-label-input" style="flex:1;"></div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <div class="id-input-group" style="flex:1;"><label>ID</label><input type="text" id="rx-monitor-id-input" style="flex:1;"></div>
                    <div class="id-input-group" style="flex:0.6;"><label>Idx</label><input type="number" id="rx-byte-index-input" style="flex:1;"></div>
                    <select id="rx-mode-select" style="flex:1;"><option value="0">1B</option><option value="1">2B-LE</option><option value="2">2B-BE</option><option value="3">1B Sig</option><option value="4">2B-L Sig</option><option value="5">2B-B Sig</option></select>
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <div class="id-input-group" style="flex:1;"><label>Mul</label><input type="text" id="rx-mul-input" style="flex:1;"></div>
                    <div class="id-input-group" style="flex:1;"><label>Add</label><input type="text" id="rx-add-input" style="flex:1;"></div>
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <div class="id-input-group" style="flex:1;"><label>Dec</label><select id="rx-dec-select" style="flex:1;"><option value="0">0</option><option value="1">0.0</option><option value="2">0.00</option></select></div>
                    <div class="id-input-group
